import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os

# Set style
sns.set(style="whitegrid")

st.markdown("""
# Exchange Program Data Analysis

We took a sample of students from various years—about 700 in total—to get a simple overview of how the exchange program works.

This application visualizes data from the KFUPM exchange program.
Below, you’ll find interactive charts that help you understand:

- **Top 5 Host Universities**: Which universities hosted the most students.
- **Top Majors**
- **GPA Distributions** by sponsor and major.
- **Comparisons** between universities and majors.
- **Correlation** among key numerical features.
""")

st.title("Exchange Program Data Analysis")

def load_datasets():
    # point at the apps/ISE291_Project folder inside your repo
    base = os.path.join(
        os.getcwd(),          # repo root
        "ISE291G1Hub",
        "apps",
        "ISE291_Project"
    )

    # — Book2 —
    excel2 = os.path.join(base, 'Book2.xlsx')
    csv2   = os.path.join(base, 'Book2.csv')
    try:
        df2 = pd.read_excel(excel2)
    except FileNotFoundError:
        df2 = pd.read_csv(csv2)

    # — Book1_GPA —
    excel1 = os.path.join(base, 'Book1_GPA.xlsx')
    try:
        df1 = pd.read_excel(excel1)
    except FileNotFoundError:
        df1 = None

    return df2, df1

# Load data
df, df1 = load_datasets()

st.subheader("Raw Data Preview (Book2)")
st.dataframe(df.sample(5))

if df1 is not None:
    st.subheader("Raw Data Preview (Book1_GPA)")
    st.dataframe(df1.sample(5))
else:
    st.warning("⚠️ Book1_GPA.xlsx not found in the app directory.")

# Clean sponsor names
df['Sponsor Name'] = df['Sponsor Name'].replace({
    'Fully Sponsored by KFUPM': 'Fully KFUPM',
    'KFUPM-Partial Sponsor':  'Partialy KFUPM'
})

# 1. Top 5 Host Universities (Pie Chart)
st.subheader("Top 5 Host Universities")
top_unis = df['Name of Host University'].value_counts().head(5)
fig1, ax1 = plt.subplots(figsize=(6, 6))
ax1.pie(top_unis, labels=top_unis.index, autopct='%1.1f%%', startangle=140)
st.pyplot(fig1)

# 12. Top 7 Host Universities (Table & Bar)
st.subheader("Top 7 Host Universities")
top7 = df['Name of Host University'].value_counts().head(7)
st.table(top7.to_frame('Count'))
fig10, ax10 = plt.subplots()
top7.plot(kind='bar', ax=ax10)
ax10.set_xlabel('University')
ax10.set_ylabel('Count')
st.pyplot(fig10)

# Context
st.subheader("Context")
st.markdown("""
We drew a random sample of 700 exchange students from various enrolment years to understand the distribution of host universities. All percentages and counts below refer to this cohort.

- Colorado School of Mines hosted the largest share, roughly 29% of our sample (≈ 203 students).
- University of Florida follows with about 22% (≈ 155 students).
- Georgia Tech accounts for 21% (≈ 147 students).
- University of North Texas and University of Cincinnati round out the top five with 15% (≈ 105) and 13% (≈ 91) respectively.

Together, these five institutions represent the vast majority of placements, with Colorado School of Mines being the top university attended by students.
""")

# 13. Heatmap: Top 7 Universities vs Majors
st.subheader("Heatmap of Top 7 Universities vs Majors")
filt = df[df['Name of Host University'].isin(top7.index)]
mat = filt.groupby(['Name of Host University', 'Major']).size().unstack(fill_value=0)
fig11, ax11 = plt.subplots(figsize=(12, 6))
sns.heatmap(mat, annot=True, fmt='d', cmap='YlGnBu', linewidths=.5, ax=ax11)
st.pyplot(fig11)

# 2. Top 10 Majors (Bar Chart)
st.subheader("Top 10 Majors")
top_majors = df['Major'].value_counts().head(10)
fig2, ax2 = plt.subplots(figsize=(8, 4))
sns.barplot(x=top_majors.values, y=top_majors.index, ax=ax2)
ax2.set_ylabel('Major')
ax2.set_xlabel('Number of Students')
st.pyplot(fig2)

# 4. Top 5 Universities vs Top 5 Majors (Clustered Bar)
st.subheader("Top 5 Universities vs Top 5 Majors")
top5_unis = top_unis.index
top5_majors = top_majors.index
data = df[df['Name of Host University'].isin(top5_unis) & df['Major'].isin(top5_majors)]
cluster_df = data.groupby(['Name of Host University', 'Major']).size().unstack(fill_value=0)
fig4 = cluster_df.plot(kind='bar', figsize=(10, 6)).get_figure()
plt.xticks(rotation=45, ha='right')
st.pyplot(fig4)

# 3. GPA by Sponsor (Box Plot Top 7)
st.subheader("GPA Distribution by Sponsor (Top 7)")
top_sponsors = df['Sponsor Name'].value_counts().head(7).index
fig3, ax3 = plt.subplots(figsize=(10, 6))
sns.boxplot(data=df[df['Sponsor Name'].isin(top_sponsors)], x='Sponsor Name', y='GPA', ax=ax3)
ax3.set_xticklabels(ax3.get_xticklabels(), rotation=45, ha='right')
st.pyplot(fig3)

# 14. GPA by Sponsor: Fully vs Partially KFUPM
st.subheader("GPA Distributions by Sponsor (KFUPM)")
for sponsor in ['Fully KFUPM', 'Partialy KFUPM']:
    sub = df[df['Sponsor Name'] == sponsor]
    fig_hist, ax_hist = plt.subplots()
    sns.histplot(sub['GPA'], bins=15, kde=True, ax=ax_hist)
    ax_hist.set_title(f'GPA Histogram – {sponsor}')
    st.pyplot(fig_hist)
    fig_box, ax_box = plt.subplots()
    sns.boxplot(y=sub['GPA'], ax=ax_box)
    ax_box.set_title(f'GPA Boxplot – {sponsor}')
    st.pyplot(fig_box)

# 7. GPA Distribution by Major (Top 10) - Box & Violin
top10_majors = df['Major'].value_counts().head(10).index
st.subheader("GPA Distribution by Major (Top 10)")
fig6, ax6 = plt.subplots(figsize=(12, 5))
sns.boxplot(data=df[df['Major'].isin(top10_majors)], x='Major', y='GPA', ax=ax6)
ax6.set_xticklabels(ax6.get_xticklabels(), rotation=45, ha='right')
st.pyplot(fig6)

st.subheader("GPA Violin Plot by Major (Top 10)")
fig7, ax7 = plt.subplots(figsize=(12, 5))
sns.violinplot(data=df[df['Major'].isin(top10_majors)], x='Major', y='GPA', ax=ax7)
ax7.set_xticklabels(ax7.get_xticklabels(), rotation=45, ha='right')
st.pyplot(fig7)

# 9. Distribution of Completed Hours
st.subheader("Total Completed Hours Distribution")
fig8, ax8 = plt.subplots(figsize=(8, 4))
sns.histplot(df['Total Completed Hours'], bins=20, kde=True, ax=ax8)
st.pyplot(fig8)

# Tag Test Type & Score Distribution
st.subheader("Test Type Tagging & Score Distribution")
df['Test Type'] = df['IELTS/TOEFL Score'].apply(lambda x: 'IELTS' if x <= 9.5 else 'TOEFL')
st.write(df['Test Type'].value_counts())
for ttype in ['IELTS', 'TOEFL']:
    fig_score, ax_score = plt.subplots()
    sns.boxplot(y=df[df['Test Type'] == ttype]['IELTS/TOEFL Score'], ax=ax_score)
    ax_score.set_title(f'{ttype} Score Distribution')
    st.pyplot(fig_score)

# 10. GPA Comparison (KFUPM vs Host)
st.subheader("GPA Comparison (KFUPM vs Host)")
if df1 is not None:
    fig_scatter, ax_scatter = plt.subplots()
    ax_scatter.scatter(df1['GPA'], df1['Host GPA'])
    ax_scatter.set_title('KFUPM GPA vs Host GPA')
    ax_scatter.set_xlabel('KFUPM GPA')
    ax_scatter.set_ylabel('Host GPA')
    st.pyplot(fig_scatter)

    df1['GPA Difference'] = df1['GPA'] - df1['Host GPA']
    diff_stats = df1['GPA Difference'].describe().to_frame().T
    st.subheader("GPA Difference Statistics")
    st.table(diff_stats)

    fig_hist2, ax_hist2 = plt.subplots()
    ax_hist2.hist(df1['GPA Difference'].dropna(), bins=20)
    ax_hist2.set_title('Distribution of GPA Difference (KFUPM – Host)')
    ax_hist2.set_xlabel('GPA Difference')
    ax_hist2.set_ylabel('Frequency')
    st.pyplot(fig_hist2)

    fig_box2, ax_box2 = plt.subplots()
    ax_box2.boxplot(df1['GPA Difference'].dropna(), vert=True, patch_artist=True)
    ax_box2.set_title('Box Plot of GPA Difference (KFUPM – Host)')
    ax_box2.set_ylabel('GPA Difference')
    st.pyplot(fig_box2)
else:
    st.warning("⚠️ No host-GPA data available (Book1_GPA.xlsx missing).")

st.subheader("OVERALL")
st.markdown("""
Most students see a small drop in GPA when they go abroad—about 0.4 points on average.
Half of them lose between 0 and 0.8 points; a few actually improve, and only a handful experience large swings in either direction.
""")
